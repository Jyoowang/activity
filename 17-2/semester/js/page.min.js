Whole.isLoading=false;Whole.uid=0;Whole.Url='https://www.yuer24h.com/wechat/view/';Whole.isApp=false;$(document).ready(function(){Page.init()})var Page={proid:0,btnTag:0,Sum:1,selectTag:0,init:function(){Page.render();Page.bind();Page.getCarCount()},bind:function(){$(".nowsetll,.shop-car").on('click',function(){Tool.goToUrl({appUrl:{type:22},h5Url:Whole.Url+'shoppingcart.html?uid='+Whole.uid})});$('.addbtn .car').on('click',Page.AddShopCartEvent);$('.addbtn .buy').on('click',Page.NowProBuyEvent);$('.mask-layer').on('click',function(){$('.product-attr-box').hide()});$(".add").on('touchstart',Page.addSum);$(".less").on('touchstart',Page.lessSum);$(".thenStroll").on('click',function(){$(".popups_add").hide()});$('#returntop').click(function(){$("body").animate({scrollTop:'0px'},200)});$('.product-box .item-img').click(function(){var proid=$(this).parent().attr('data-proid');Tool.goToUrl({appUrl:{type:11,typeName:proid},h5Url:Whole.Url+'proshow.html?uid='+Whole.uid+'&proid='+proid})})},render:function(){var tit=Tool.locationObject();if(tit){if(tit['uid']){Whole.uid=tit['uid']}if(tit['isApp']){Whole.isApp=true}}},AddShopCartEvent:function(){Page.proid=$(this).parents('.product-box').attr('data-proid');console.log(Page.proid);Page.btnTag=1;Page.getProDetail()},NowProBuyEvent:function(){Page.proid=$(this).parents('.product-box').attr('data-proid');console.log(Page.proid);Page.btnTag=2;Page.getProDetail()},getProDetail:function(){var data={UserID:Whole.uid,ProductID:Page.proid,SpreadID:0,SpreadType:0,}Whole.isLoading=true;Tool.firstAjax({isload:{loadVal:true},url:'/app/Mall_HomeApi/GetProductDetatil2',value:data,success:function(value){Whole.isLoading=false;Page.ProData=value;if(!value.IsSale){}else{Page.pushProInfo(value);Page.processEvent()}}})},processEvent:function(){Page.Sum=1;if(Page.btnTag==1){if(Page.judgmentSpecification()){Page.AddShopCart()}else{if(!Page.selectTag){$('.sumAnd').html(Page.Sum);$('.product-attr-box').show();$(".col-define").off('click');$('.col-define').on('click',function(){Page.isButtonEvent(1)})}else{popupsUtil.init({msgText:'请选择规格',yesEvent:function(){return},noEvent:function(){console.log('取消')}})}}}else if(Page.btnTag==2){if(Page.judgmentSpecification()){Page.NowProBuy()}else{if(!Page.selectTag){$('.sumAnd').html(Page.Sum);$('.product-attr-box').show();$(".col-define").off('click');$('.col-define').on('click',function(){Page.isButtonEvent(0)})}else{popupsUtil.init({msgText:'请选择规格',yesEvent:function(){return},noEvent:function(){console.log('取消')}})}}}},AddShopCart:function(){var keys=[];for(var key in Page.currentAttr){if(Page.currentAttr[key]){keys.push(Page.currentAttr[key])}}var data={UserID:Whole.uid,ProductID:Page.proid,AIDs:String(keys[0].AID)+","+String(keys[1].AID),Pcount:Page.Sum,SpreadID:0,SpreadType:0,PackAgeID:0,CourseID:0,}var isloadObj={loadVal:true,loadView:{loadText:false,isTransparent:true}}Whole.isLoading=true;Tool.firstAjax({isload:isloadObj,url:'/app/Mall_HomeApi/GetAddShopCart',value:data,success:function(value){Whole.isLoading=false;if(value.ResultCode==1){$(".mask-layer").click();$(".shop-car span").html(value.ShopCartCount);$(".popups_add").show()}else if(value.ResultCode==100){}}})},NowProBuy:function(){var keys=[];for(var key in Page.currentAttr){if(Page.currentAttr[key]){keys.push(Page.currentAttr[key])}}var data={UserID:Whole.uid,ProductID:Page.proid,AIDs:String(keys[0].AID)+","+String(keys[1].AID),Pcount:Page.Sum,SpreadID:0,SpreadType:0,PackAgeID:0,CourseID:0,}Whole.isLoading=true;Tool.firstAjax({isload:{loadVal:false},url:'/app/Mall_HomeApi/GetOneKeyProductBuy',value:data,success:function(value){Whole.isLoading=false;if(value.ResultCode==100){popupsUtil.init({msgText:value.ResultMessage,yesEvent:function(){return},noEvent:function(){console.log('取消')}})}else{var josn=Tool.getString(value,'Json');Tool.SessionAttr.setSwssionAttr('jsonstring',josn);var josnObj=JSON.parse(josn);Tool.goToUrl({appUrl:{type:77,typeName:josnObj},h5Url:Whole.Url+'clearing.html?uid='+Whole.uid})}}})},judgmentSpecification:function(){if(!Whole.uid){Tool.isApp(function(){Tool.goToUrl({appUrl:{type:76,typeName:Page.proid},})})return false}var keys=[];for(var key in Page.currentAttr){if(Page.currentAttr[key]){keys.push(Page.currentAttr[key])}}if(keys.length==2){return true}else{return false}},isButtonEvent:function(tag){if(Page.judgmentSpecification()){if(tag){Page.AddShopCart()}else{Page.NowProBuy()}}else{popupsUtil.init({msgText:'请选择规格',yesEvent:function(){return},noEvent:function(){console.log('取消')}})}},pushProInfo:function(value){Page.currentAttr={}Page.AttrData=value.Attrs;Page.StocksList={};Page.currPrice=value.StocksList[0];Page.earm=value.StocksList[0].Price;Page.stock=0;for(var i=0;i<value.StocksList.length;i++){var tempObj=value.StocksList[i];if(Page.currPrice.Price>tempObj.Price){Page.currPrice=tempObj}if(Page.earm<tempObj.Price){Page.earm=tempObj.Price}Page.stock+=tempObj.Num Page.StocksList[tempObj.Specifications]=tempObj}if(Page.AttrData){if(Page.AttrData.length>1){var temp=Page.AttrData[0];var tempAr=temp["AttrValues"];if(tempAr.length>0){var sel1=tempAr[0];Page.currentAttr[temp["AttID"]]=sel1;var temp2=Page.AttrData[1];var tempAr2=temp2["AttrValues"];if(tempAr2.length==1){var sel2=tempAr2[0];var tempNum=Page.getStocksInfo(sel1["AID"],sel2["AID"]);if(tempNum&&tempNum["Num"]>0){Page.currentAttr[temp2["AttID"]]=sel2}}Page.currentMinPrice()}}if(value.Attrs.length){Page.pushAttrsHtml()}}var w=parseInt($(window).width()*0.4);var h=parseInt($(window).width()*0.38*0.9);$('.pro-info .pro-img').css({height:h+'px'})$('.pro-info .pro-img img').attr('src',Tool.getPicUrl(value.PicDomain+value.SmallImg,w,h))},currentMinPrice:function(){var keys=[];for(var key in Page.currentAttr){if(Page.currentAttr[key]){keys.push(key)}}if(keys.length==0){Page.stock=0;for(var key in Page.StocksList){var tempObj=Page.StocksList[key];if(Page.currPrice.Price>tempObj.Price){Page.currPrice=tempObj}Page.stock+=tempObj.Num}}else if(keys.length==1){var AID=Page.currentAttr[keys[0]].AID;var stockAr=[];for(var key in Page.StocksList){if(key.indexOf(AID)!=-1){stockAr.push(Page.StocksList[key])}}if(stockAr.length){Page.currPrice=stockAr[0];Page.stock=0;for(var i=0;i<stockAr.length;i++){if(Page.currPrice.Price>stockAr[i].Price){Page.currPrice=stockAr[i]}Page.stock+=stockAr[i].Num}}}},selectAttrs:function(attrObj,attid){if(Page.currentAttr[attid]&&Page.currentAttr[attid].AID==attrObj.AID){Page.currentAttr[attid]=null}else{Page.currentAttr[attid]=attrObj}Page.pushAttrsHtml()},getStocksInfo:function(aid1,aid2){if(Page.StocksList[aid1+","+aid2]){return Page.StocksList[aid1+","+aid2]}else if(Page.StocksList[aid2+","+aid1]){return Page.StocksList[aid2+","+aid1]}else{return false}},pushAttrsHtml:function(){var keys=[];for(var key in Page.currentAttr){if(Page.currentAttr[key]){keys.push(key)}}var str='';var str1='';for(var i=0;i<Page.AttrData.length;i++){var tempAttr=Page.AttrData[i];str+='<div class="param-box" >'str+='<p>'+tempAttr.AName+'</p>'str1+='<em>'+tempAttr.AName+'</em>'str+='<div class="row" data-id="'+i+'">'for(var j=0;j<tempAttr.AttrValues.length;j++){var tempObj=tempAttr.AttrValues[j];if(Page.currentAttr[tempAttr.AttID]&&tempObj.AID==Page.currentAttr[tempAttr.AttID].AID){str+='<span class="active"'}else{if(keys.length<=0){str+='<span '}else if(keys.length==1){if(keys[0]==tempAttr.AttID){str+='<span '}else{var tempStock=Page.getStocksInfo(Page.currentAttr[keys[0]].AID,tempObj.AID);if(tempStock){if(tempStock.Num>0){str+='<span '}else{str+='<span class="cur"'}}else{str+='<span class="cur"'}}}else if(keys.length==2){var tempAttrs='<span ';if(keys[0]!=tempAttr.AttID){var tempStock=Page.getStocksInfo(Page.currentAttr[keys[0]].AID,tempObj.AID);if(tempStock){if(tempStock.Num>0){tempAttrs='<span '}else{tempAttrs='<span class="cur"'}}else{tempAttrs='<span class="cur"'}}if(keys[1]!=tempAttr.AttID){var tempStock=Page.getStocksInfo(Page.currentAttr[keys[1]].AID,tempObj.AID);if(tempStock){if(tempStock.Num>0){tempAttrs='<span '}else{tempAttrs='<span class="cur"'}}else{tempAttrs='<span class="cur"'}}str+=tempAttrs}}str+='data-id="'+j+'">'+tempObj.AValue+'<i></i></span>'}str+='</div>'str+='</div>'}$(".attr-boxs").html(str)$(".attr-boxs .param-box span").off('click')$(".attr-boxs .param-box span").on('click',function(){if(!$(this).hasClass('cur')){var _thisJ=$(this).attr('data-id')var _thisI=$(this).parent().attr('data-id')Page.selectAttrs(Page.AttrData[_thisI].AttrValues[_thisJ],Page.AttrData[_thisI].AttID)}})Page.currentMinPrice();var currPrice,stock,strTxt;var pdd='请'if(keys.length==2){var dds=Page.getStocksInfo(Page.currentAttr[keys[0]].AID,Page.currentAttr[keys[1]].AID)currPrice=dds.Price;stock=dds.Num;strTxt='<em>"'+Page.currentAttr[keys[0]].AValue+'"</em><em>"'+Page.currentAttr[keys[1]].AValue+'"</em></span>'pdd='已'}else if(keys.length==1){currPrice=Page.currPrice.Price;stock=Page.stock;if(Page.AttrData[0].AttID==keys[0]){strTxt='<em>"'+Page.AttrData[1].AName+'"</em>'}else{strTxt='<em>"'+Page.AttrData[0].AName+'"</em>'}}else{currPrice=Page.currPrice.Price stock=Page.stock strTxt=str1;}$(".pro-text").html('<p>￥'+Tool.getPriceValue(currPrice)+'</p><em>库存'+stock+'件</em><span>'+pdd+'选择:'+strTxt+'</span>')},getCarCount:function(){var data={UserID:Whole.uid,}Tool.firstAjax({isload:{loadVal:true,loadView:{loadText:false,isTransparent:true}},url:'/app/Mall_HomeApi/GetShopCartCount',value:data,success:function(value){Whole.isLoading=false;$('.car span').html(value.ShopCartCount)}})},quantity:function(tag,_this){var sum=Number(_this.parent().find('.sumAnd').html())if(tag){sum=sum+1}else{sum=sum-1}_this.parent().find('.sumAnd').html(sum)Page.Sum=sum;},addSum:function(){Page.quantity(true,$(this))},lessSum:function(){if(Number($(this).parent().find('.sumAnd').html())<=1){popupsUtil.init({msgText:'不能再减了哦~',yesEvent:function(){return},noEvent:function(){console.log('取消')}})}else{Page.quantity(false,$(this))}return false}}